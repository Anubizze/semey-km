<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .metric-card {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .metric-value {
      color: #1e293b;
      font-weight: 700;
    }
    .metric-label {
      color: #64748b;
      font-weight: 500;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-good { background-color: #10b981; }
    .status-warning { background-color: #f59e0b; }
    .status-danger { background-color: #ef4444; }
    .status-info { background-color: #3b82f6; }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
      .max-w-7xl {
        padding: 0 1rem;
      }
      .grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .grid-cols-2 {
        grid-template-columns: 1fr;
      }
      .grid-cols-3 {
        grid-template-columns: 1fr;
      }
      .grid-cols-4 {
        grid-template-columns: 1fr;
      }
      .grid-cols-5 {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-cols-7 {
        grid-template-columns: repeat(2, 1fr);
      }
      .metric-card {
        padding: 1rem;
      }
      .metric-value {
        font-size: 1.5rem;
      }
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table {
        font-size: 12px;
        min-width: 600px;
      }
      .table th, .table td {
        padding: 8px 4px;
        white-space: nowrap;
      }
      .flex {
        flex-direction: column;
        gap: 0.5rem;
      }
      .flex.justify-between {
        align-items: flex-start;
      }
      .text-right {
        text-align: left;
      }
      .space-x-4 > * + * {
        margin-left: 0;
        margin-top: 0.5rem;
      }
      .space-x-2 > * + * {
        margin-left: 0;
        margin-top: 0.25rem;
      }
      .space-y-3 > * + * {
        margin-top: 0.75rem;
      }
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
      .space-y-6 > * + * {
        margin-top: 1.5rem;
      }
      .space-y-8 > * + * {
        margin-top: 2rem;
      }
      .h-64 {
        height: 200px;
      }
      .h-80 {
        height: 250px;
      }
      .text-sm {
        font-size: 11px;
      }
      .text-xs {
        font-size: 10px;
      }
      .px-4 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .py-3 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .p-6 {
        padding: 1rem;
      }
      .p-4 {
        padding: 0.75rem;
      }
      .mb-8 {
        margin-bottom: 1.5rem;
      }
      .mb-6 {
        margin-bottom: 1rem;
      }
      .mb-4 {
        margin-bottom: 0.75rem;
      }
      .mt-4 {
        margin-top: 0.75rem;
      }
      .mt-6 {
        margin-top: 1rem;
      }
      .mt-8 {
        margin-top: 1.5rem;
      }
      .text-lg {
        font-size: 1rem;
      }
      .text-xl {
        font-size: 1.125rem;
      }
      .text-2xl {
        font-size: 1.25rem;
      }
      .text-3xl {
        font-size: 1.5rem;
      }
      .text-4xl {
        font-size: 1.75rem;
      }
      .text-5xl {
        font-size: 2rem;
      }
      .text-6xl {
        font-size: 2.25rem;
      }
      .text-7xl {
        font-size: 2.5rem;
      }
      .text-8xl {
        font-size: 2.75rem;
      }
      .text-9xl {
        font-size: 3rem;
      }
    }
    
    @media (max-width: 480px) {
      .max-w-7xl {
        padding: 0 0.5rem;
      }
      .grid-cols-5 {
        grid-template-columns: 1fr;
      }
      .grid-cols-7 {
        grid-template-columns: 1fr;
      }
      .metric-card {
        padding: 0.75rem;
      }
      .metric-value {
        font-size: 1.25rem;
      }
      .table {
        font-size: 10px;
        min-width: 500px;
      }
      .table th, .table td {
        padding: 6px 2px;
      }
      .text-sm {
        font-size: 10px;
      }
      .text-xs {
        font-size: 9px;
      }
      .h-64 {
        height: 150px;
      }
      .h-80 {
        height: 200px;
      }
      .px-4 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      .py-3 {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }
      .p-6 {
        padding: 0.75rem;
      }
      .p-4 {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <img src="{{ url_for('static', filename='images/logo_0.png') }}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="h-12 w-auto mr-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">
              {% if session.get('role') == 'chief_technologist' %}
                –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º - –ì–ª–∞–≤–Ω—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥
              {% else %}
                –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º - –î–∏—Ä–µ–∫—Ç–æ—Ä
              {% endif %}
            </h1>
            <p class="text-sm text-gray-600">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-500">{{ date_from }} - {{ date_to }}</span>
          <a href="/logout" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            –í—ã—Ö–æ–¥
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <form method="GET" action="/director_dashboard" class="grid grid-cols-1 md:grid-cols-7 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ —Å</label>
          <input type="date" name="date_from" value="{{ date_from }}" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –ø–æ</label>
          <input type="date" name="date_to" value="{{ date_to }}" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–¢–∏–ø –ø–∞—Ä—Ç–∏–∏</label>
          <select name="batch_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if batch_type_filter == 'all' %}selected{% endif %}>–í—Å–µ —Ç–∏–ø—ã</option>
            <option value="cutting" {% if batch_type_filter == 'cutting' %}selected{% endif %}>–†–µ–∑–∫–∞</option>
            <option value="autoclave" {% if batch_type_filter == 'autoclave' %}selected{% endif %}>–ê–≤—Ç–æ–∫–ª–∞–≤</option>
            <option value="casting" {% if batch_type_filter == 'casting' %}selected{% endif %}>–ó–∞–ª–∏–≤–∫–∞</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
          <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
            <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</option>
            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–æ–¥—É–∫—Ç</label>
          <select name="product" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if product_filter == 'all' %}selected{% endif %}>–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã</option>
            {% for product in products %}
            <option value="{{ product.id }}" {% if product_filter == product.id|string %}selected{% endif %}>{{ product.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</label>
          <select name="equipment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if equipment_filter == 'all' %}selected{% endif %}>–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
            {% for eq in equipment %}
            <option value="{{ eq.id }}" {% if equipment_filter == eq.id|string %}selected{% endif %}>{{ eq.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-end space-x-2">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            –ü—Ä–∏–º–µ–Ω–∏—Ç—å
          </button>
          <a href="/director_dashboard" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition-colors">
            –°–±—Ä–æ—Å–∏—Ç—å
          </a>
        </div>
      </form>
      
      <!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <div class="mt-4 flex flex-wrap gap-2">
        <a href="{{ url_for('export_batches_csv', date_from=date_from, date_to=date_to, batch_type=batch_type_filter, status=status_filter, product=product_filter, equipment=equipment_filter) }}" 
           class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          üìä –≠–∫—Å–ø–æ—Ä—Ç –ø–∞—Ä—Ç–∏–π (Excel)
        </a>
        <a href="{{ url_for('export_entries_csv', date_from=date_from, date_to=date_to) }}" 
           class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          üìã –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–ø–∏—Å–µ–π (Excel)
        </a>
        <a href="{{ url_for('export_analytics_csv', date_from=date_from, date_to=date_to) }}" 
           class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          üìà –≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (Excel)
        </a>
        <a href="{{ url_for('clear_cache') }}" 
           class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"
           onclick="return confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.')">
          üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
        </a>
        <a href="{{ url_for('cache_status') }}" 
           class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          üìä –°—Ç–∞—Ç—É—Å –∫—ç—à–∞
        </a>
        {% if session.get('role') == 'chief_technologist' %}
        <a href="/templates" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          üìã –®–∞–±–ª–æ–Ω—ã –ø–∞—Ä—Ç–∏–π
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- 7 –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      
      <!-- 1. –û–±—â–∞—è –≤—ã—Ä–∞–±–æ—Ç–∫–∞ -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">–û–±—â–∞—è –≤—ã—Ä–∞–±–æ—Ç–∫–∞</p>
            <p class="metric-value text-3xl">{{ total_production }}</p>
            <p class="text-xs text-gray-500 mt-1">–ø–∞—Ä—Ç–∏–π</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator status-info"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. –ü—Ä–æ—Å—Ç–æ–π -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">–ü—Ä–æ—Å—Ç–æ–π</p>
            <p class="metric-value text-3xl">{{ downtime_batches }}</p>
            <p class="text-xs text-gray-500 mt-1">–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if downtime_batches > 5 %}status-danger{% elif downtime_batches > 2 %}status-warning{% else %}status-good{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
            <p class="metric-value text-3xl">{{ active_time_batches }}</p>
            <p class="text-xs text-gray-500 mt-1">–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator status-good"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">–¢–µ–∫—É—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–∞–∫–∞ -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–∞–∫–∞</p>
            <p class="metric-value text-3xl">{{ defect_batches }}</p>
            <p class="text-xs text-gray-500 mt-1">–¥–µ—Ñ–µ–∫—Ç–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if defect_batches > 3 %}status-danger{% elif defect_batches > 1 %}status-warning{% else %}status-good{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 5. –ù–∞—Ä—É—à–µ–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">–ù–∞—Ä—É—à–µ–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π</p>
            <p class="metric-value text-3xl">{{ tech_violations }}</p>
            <p class="text-xs text-gray-500 mt-1">–Ω–∞—Ä—É—à–µ–Ω–∏–π</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if tech_violations > 2 %}status-danger{% elif tech_violations > 0 %}status-warning{% else %}status-good{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">–°–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 6. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
            <p class="metric-value text-3xl">{{ "%.1f"|format(efficiency) }}%</p>
            <p class="text-xs text-gray-500 mt-1">–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if efficiency >= 80 %}status-good{% elif efficiency >= 60 %}status-warning{% else %}status-danger{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 7. –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</p>
            <p class="metric-value text-3xl">{{ "%.0f"|format(avg_duration) }}</p>
            <p class="text-xs text-gray-500 mt-1">–º–∏–Ω—É—Ç</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator status-info"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- –ü–∞—Ä—Ç–∏–∏ —Ä–µ–∑–∫–∏ -->
        <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-blue-800">–†–µ–∑–∫–∞</h4>
            <span class="text-2xl">‚úÇÔ∏è</span>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">–í—Å–µ–≥–æ –ø–∞—Ä—Ç–∏–π:</span>
              <span class="text-2xl font-bold text-blue-700">{{ total_cutting_batches }}</span>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                <div class="text-lg font-bold text-green-600">{{ active_cutting }}</div>
              </div>
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö</div>
                <div class="text-lg font-bold text-gray-600">{{ completed_cutting }}</div>
              </div>
            </div>
            <div class="bg-white/60 rounded-md p-3">
              <div class="text-xs text-gray-600 mb-1">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
              <div class="text-lg font-bold text-blue-700">{{ "%.0f"|format(avg_cutting_duration) }} –º–∏–Ω</div>
            </div>
          </div>
        </div>

        <!-- –¶–∏–∫–ª—ã –∞–≤—Ç–æ–∫–ª–∞–≤–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-purple-800">–ê–≤—Ç–æ–∫–ª–∞–≤</h4>
            <span class="text-2xl">üî•</span>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">–í—Å–µ–≥–æ —Ü–∏–∫–ª–æ–≤:</span>
              <span class="text-2xl font-bold text-purple-700">{{ total_autoclave_batches }}</span>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                <div class="text-lg font-bold text-green-600">{{ active_autoclave }}</div>
              </div>
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö</div>
                <div class="text-lg font-bold text-gray-600">{{ completed_autoclave }}</div>
              </div>
            </div>
            <div class="bg-white/60 rounded-md p-3">
              <div class="text-xs text-gray-600 mb-1">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
              <div class="text-lg font-bold text-purple-700">{{ "%.0f"|format(avg_autoclave_duration) }} –º–∏–Ω</div>
            </div>
          </div>
        </div>

        <!-- –ü–∞—Ä—Ç–∏–∏ –∑–∞–ª–∏–≤–∫–∏ -->
        <div class="p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg border border-orange-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-orange-800">–ó–∞–ª–∏–≤–∫–∞</h4>
            <span class="text-2xl">üß±</span>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">–í—Å–µ–≥–æ –ø–∞—Ä—Ç–∏–π:</span>
              <span class="text-2xl font-bold text-orange-700">{{ total_casting_batches }}</span>
            </div>
            <div class="bg-white/60 rounded-md p-4">
              <p class="text-sm text-gray-600">
                üìã –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ "–í—Å–µ –ø–∞—Ä—Ç–∏–∏"
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å–º–µ–Ω–∞–º -->
        <div class="relative">
          <h4 class="text-md font-medium text-gray-700 mb-4">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–º–µ–Ω–∞–º</h4>
          <div class="relative h-64">
            <canvas id="shiftChart"></canvas>
          </div>
          
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º –æ–ø–µ—Ä–∞—Ü–∏–π -->
          <div class="mt-4 space-y-3">
            <div class="text-sm text-gray-600 font-medium mb-2">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º:</div>
            
            <!-- –ó–∞–ª–∏–≤–∫–∞ -->
            <div class="flex items-center justify-between p-2 bg-blue-50 rounded-md">
              <div class="flex items-center">
                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                <span class="text-sm font-medium text-gray-700">–ó–∞–ª–∏–≤–∫–∞</span>
              </div>
              <div class="flex space-x-4 text-xs">
                <span class="text-blue-600">üåÖ {{ day_entries_casting }}</span>
                <span class="text-gray-600">üåô {{ night_entries_casting }}</span>
              </div>
            </div>
            
            <!-- –†–µ–∑–∫–∞ -->
            <div class="flex items-center justify-between p-2 bg-green-50 rounded-md">
              <div class="flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                <span class="text-sm font-medium text-gray-700">–†–µ–∑–∫–∞</span>
              </div>
              <div class="flex space-x-4 text-xs">
                <span class="text-green-600">üåÖ {{ day_entries_cutting }}</span>
                <span class="text-gray-600">üåô {{ night_entries_cutting }}</span>
              </div>
            </div>
            
            <!-- –ê–≤—Ç–æ–∫–ª–∞–≤ -->
            <div class="flex items-center justify-between p-2 bg-purple-50 rounded-md">
              <div class="flex items-center">
                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                <span class="text-sm font-medium text-gray-700">–ê–≤—Ç–æ–∫–ª–∞–≤</span>
              </div>
              <div class="flex space-x-4 text-xs">
                <span class="text-purple-600">üåÖ {{ day_entries_autoclave }}</span>
                <span class="text-gray-600">üåô {{ night_entries_autoclave }}</span>
              </div>
            </div>
          </div>
        </div>
        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
        <div class="relative">
          <h4 class="text-md font-medium text-gray-700 mb-4">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h4>
          <div class="relative h-64">
            <canvas id="materialsChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      
      <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –ø–∞—Ä—Ç–∏–π -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –ø–∞—Ä—Ç–∏–π</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between p-3 bg-blue-50 rounded-md">
            <div class="flex items-center">
              <span class="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>
              <span class="text-sm font-medium text-gray-700">–†–µ–∑–∫–∞</span>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">{{ total_cutting_batches }}</p>
              <p class="text-xs text-gray-500">–ø–∞—Ä—Ç–∏–π</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-purple-50 rounded-md">
            <div class="flex items-center">
              <span class="w-3 h-3 bg-purple-500 rounded-full mr-3"></span>
              <span class="text-sm font-medium text-gray-700">–ê–≤—Ç–æ–∫–ª–∞–≤</span>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">{{ total_autoclave_batches }}</p>
              <p class="text-xs text-gray-500">—Ü–∏–∫–ª–æ–≤</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-orange-50 rounded-md">
            <div class="flex items-center">
              <span class="w-3 h-3 bg-orange-500 rounded-full mr-3"></span>
              <span class="text-sm font-medium text-gray-700">–ó–∞–ª–∏–≤–∫–∞</span>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">{{ total_casting_batches }}</p>
              <p class="text-xs text-gray-500">–ø–∞—Ä—Ç–∏–π</p>
            </div>
          </div>
        </div>
      </div>

      <!-- –†–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">–†–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h3>
        <div class="space-y-3">
          {% for material_name, data in materials_total.items() %}
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">{{ material_name }}</span>
            <div class="text-right">
              <span class="text-sm font-semibold text-gray-900">{{ "%.1f"|format(data.quantity) }}</span>
              <span class="text-xs text-gray-500 ml-1">{{ data.unit }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

    </div>

    <!-- –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ —Å—ã—Ä—å—è –∑–∞ –ø–µ—Ä–∏–æ–¥ -->
    {% if materials_total %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ —Å—ã—Ä—å—è –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for material_name, data in materials_total.items() %}
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center">
          <p class="text-sm font-medium text-gray-600 mb-2">{{ material_name }}</p>
          <p class="text-2xl font-bold text-gray-900 mb-1">{{ "%.1f"|format(data.quantity) }}</p>
          <p class="text-xs text-gray-500 uppercase">{{ data.unit }}</p>
        </div>
        {% endfor %}
      </div>
      <div class="mt-4 pt-4 border-t border-gray-200">
        <div class="flex items-center justify-between text-sm text-gray-600">
          <span>üìÖ –ü–µ—Ä–∏–æ–¥: {{ date_from }} - {{ date_to }}</span>
          {% if batch_type_filter != 'all' %}
          <span>üîç –¢–∏–ø –ø–∞—Ä—Ç–∏–∏: 
            {% if batch_type_filter == 'casting' %}–ó–∞–ª–∏–≤–∫–∞
            {% elif batch_type_filter == 'cutting' %}–†–µ–∑–∫–∞
            {% elif batch_type_filter == 'autoclave' %}–ê–≤—Ç–æ–∫–ª–∞–≤
            {% endif %}
          </span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º -->
    {% if products_stats %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for product_code, stats in products_stats.items() %}
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-gray-900">{{ product_code }}</h4>
            <span class="text-sm text-gray-500">{{ stats.name }}</span>
          </div>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="bg-blue-50 rounded-md p-2">
              <div class="text-xs text-gray-600">–í—Å–µ–≥–æ</div>
              <div class="text-lg font-bold text-blue-600">{{ stats.total }}</div>
            </div>
            <div class="bg-green-50 rounded-md p-2">
              <div class="text-xs text-gray-600">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
              <div class="text-lg font-bold text-green-600">{{ stats.active }}</div>
            </div>
            <div class="bg-gray-50 rounded-md p-2">
              <div class="text-xs text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö</div>
              <div class="text-lg font-bold text-gray-600">{{ stats.completed }}</div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- –†–∞—Å—Ö–æ–¥ —Å—ã—Ä—å—è –ø–æ —Ç–∏–ø–∞–º –ø–∞—Ä—Ç–∏–π -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–†–∞—Å—Ö–æ–¥ —Å—ã—Ä—å—è –ø–æ —Ç–∏–ø–∞–º –ø–∞—Ä—Ç–∏–π</h3>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- –ó–∞–ª–∏–≤–∫–∞ -->
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="font-semibold text-blue-800 mb-3">–ó–∞–ª–∏–≤–∫–∞</h4>
          {% if materials_by_batch_type.casting %}
          <div class="space-y-2">
            {% for material_name, data in materials_by_batch_type.casting.items() %}
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-700">{{ material_name }}</span>
              <span class="font-semibold text-blue-700">{{ "%.1f"|format(data.quantity) }} {{ data.unit }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
          {% endif %}
        </div>

        <!-- –†–µ–∑–∫–∞ -->
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
          <h4 class="font-semibold text-green-800 mb-3">–†–µ–∑–∫–∞</h4>
          {% if materials_by_batch_type.cutting %}
          <div class="space-y-2">
            {% for material_name, data in materials_by_batch_type.cutting.items() %}
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-700">{{ material_name }}</span>
              <span class="font-semibold text-green-700">{{ "%.1f"|format(data.quantity) }} {{ data.unit }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
          {% endif %}
        </div>

        <!-- –ê–≤—Ç–æ–∫–ª–∞–≤ -->
        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
          <h4 class="font-semibold text-purple-800 mb-3">–ê–≤—Ç–æ–∫–ª–∞–≤</h4>
          {% if materials_by_batch_type.autoclave %}
          <div class="space-y-2">
            {% for material_name, data in materials_by_batch_type.autoclave.items() %}
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-700">{{ material_name }}</span>
              <span class="font-semibold text-purple-700">{{ "%.1f"|format(data.quantity) }} {{ data.unit }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏ —Ä–µ–∑–∫–∏ -->
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="text-md font-semibold text-blue-800 mb-4 flex items-center">
            <span class="mr-2">‚úÇÔ∏è</span> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏ —Ä–µ–∑–∫–∏
          </h4>
          {% if cutting_batches %}
          <div class="space-y-3 max-h-64 overflow-y-auto">
            {% for batch, user in cutting_batches[:5] %}
            <div class="p-3 bg-white rounded-md border-l-4 {% if batch.status == 'active' %}border-green-500{% elif batch.status == 'cancelled' %}border-red-500{% elif batch.status == 'inactive' %}border-yellow-500{% else %}border-gray-400{% endif %}">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold text-gray-900">{{ batch.batch_number }}</p>
                  <p class="text-sm text-gray-600">–†–µ–∑—á–∏–∫: {{ user.fio }}</p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full {% if batch.status == 'active' %}bg-green-100 text-green-800{% elif batch.status == 'cancelled' %}bg-red-100 text-red-800{% elif batch.status == 'inactive' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                  {% if batch.status == 'active' %}–ê–∫—Ç–∏–≤–Ω–∞{% elif batch.status == 'cancelled' %}–û—Ç–º–µ–Ω–µ–Ω–∞{% elif batch.status == 'inactive' %}–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞{% else %}–ó–∞–≤–µ—Ä—à–µ–Ω–∞{% endif %}
                </span>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                –ù–∞—á–∞–ª–æ: {{ batch.start_time.strftime('%d.%m.%Y %H:%M') }}
                {% if batch.end_time %}
                | –û–∫–æ–Ω—á–∞–Ω–∏–µ: {{ batch.end_time.strftime('%H:%M') }}
                {% endif %}
              </p>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-center py-4">–ù–µ—Ç –ø–∞—Ä—Ç–∏–π —Ä–µ–∑–∫–∏</p>
          {% endif %}
          <div class="mt-4">
            <a href="/batch_list" class="text-blue-600 hover:underline text-sm">–í—Å–µ –ø–∞—Ä—Ç–∏–∏ ‚Üí</a>
          </div>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏–∫–ª—ã –∞–≤—Ç–æ–∫–ª–∞–≤–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
          <h4 class="text-md font-semibold text-purple-800 mb-4 flex items-center">
            <span class="mr-2">üî•</span> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏–∫–ª—ã –∞–≤—Ç–æ–∫–ª–∞–≤–∏—Ä–æ–≤–∞–Ω–∏—è
          </h4>
          {% if autoclave_batches %}
          <div class="space-y-3 max-h-64 overflow-y-auto">
            {% for batch, user in autoclave_batches[:5] %}
            <div class="p-3 bg-white rounded-md border-l-4 {% if batch.status == 'active' %}border-purple-500{% elif batch.status == 'cancelled' %}border-red-500{% elif batch.status == 'inactive' %}border-yellow-500{% else %}border-gray-400{% endif %}">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold text-gray-900">{{ batch.batch_number }}</p>
                  <p class="text-sm text-gray-600">–ê–≤—Ç–æ–∫–ª–∞–≤—â–∏–∫: {{ user.fio }}</p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full {% if batch.status == 'active' %}bg-purple-100 text-purple-800{% elif batch.status == 'cancelled' %}bg-red-100 text-red-800{% elif batch.status == 'inactive' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                  {% if batch.status == 'active' %}–ê–∫—Ç–∏–≤–µ–Ω{% elif batch.status == 'cancelled' %}–û—Ç–º–µ–Ω–µ–Ω{% elif batch.status == 'inactive' %}–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω{% else %}–ó–∞–≤–µ—Ä—à–µ–Ω{% endif %}
                </span>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                –ù–∞—á–∞–ª–æ: {{ batch.start_time.strftime('%d.%m.%Y %H:%M') }}
                {% if batch.end_time %}
                | –û–∫–æ–Ω—á–∞–Ω–∏–µ: {{ batch.end_time.strftime('%H:%M') }}
                {% endif %}
              </p>
              {% if batch.equipment %}
              <p class="text-xs text-gray-500 mt-1">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: {{ batch.equipment.name }}</p>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-center py-4">–ù–µ—Ç —Ü–∏–∫–ª–æ–≤ –∞–≤—Ç–æ–∫–ª–∞–≤–∏—Ä–æ–≤–∞–Ω–∏—è</p>
          {% endif %}
          <div class="mt-4">
            <a href="/batch_list" class="text-purple-600 hover:underline text-sm">–í—Å–µ –ø–∞—Ä—Ç–∏–∏ ‚Üí</a>
          </div>
        </div>

      </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤–≤–æ–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤–≤–æ–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto">
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200">
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–∞—Ç–∞</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–í—Ä–µ–º—è</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°–º–µ–Ω–∞</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¶–µ–º–µ–Ω—Ç (–∫–≥)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ò–∑–≤–µ—Å—Ç—å (–∫–≥)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ê–ª. –ø—É–¥—Ä–∞ (–∫–≥)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–í–æ–¥–∞ (–ª)</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for entry in material_entries[:10] %}
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ entry.datetime.date() }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ entry.datetime.time().strftime('%H:%M:%S') }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                {{ entry.user.fio }}
                {% if entry.type == 'batch' %}
                  <span class="text-xs text-gray-500">({{ entry.batch_type }})</span>
                {% endif %}
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span class="px-2 py-1 text-xs rounded-full {{ 'bg-yellow-100 text-yellow-800' if entry.shift == 'day' else 'bg-blue-100 text-blue-800' }}">
                  {{ '–î–Ω–µ–≤–Ω–∞—è' if entry.shift == 'day' else '–ù–æ—á–Ω–∞—è' }}
                </span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.cement) }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.lime) }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.aluminum_powder) }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.water) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if not material_entries %}
      <div class="text-center py-8">
        <p class="text-gray-500">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤–≤–æ–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
      </div>
      {% endif %}
    </div>

    <!-- –õ–µ–Ω—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π -->
    {% if entries_timeline %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">–õ–µ–Ω—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
      <div class="space-y-3 max-h-96 overflow-y-auto">
        {% for item in entries_timeline[:15] %}
        <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-md">
          <div class="flex-shrink-0">
            {% if item.type == 'entry' %}
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <span class="text-blue-600 text-sm">üìù</span>
              </div>
            {% elif item.type == 'batch' %}
              <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <span class="text-green-600 text-sm">
                  {% if item.data.batch_type == 'cutting' %}‚úÇÔ∏è
                  {% elif item.data.batch_type == 'autoclave' %}üî•
                  {% elif item.data.batch_type == 'casting' %}üß±
                  {% else %}üì¶{% endif %}
                </span>
              </div>
            {% endif %}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900">{{ item.description }}</p>
            <div class="flex items-center space-x-2">
              <p class="text-xs text-gray-500">{{ item.user.fio }} ‚Ä¢ {{ item.datetime.strftime('%d.%m.%Y %H:%M') }}</p>
              {% if item.type == 'batch' %}
              <span class="px-2 py-1 text-xs rounded-full {% if item.data.status == 'active' %}bg-green-100 text-green-800{% elif item.data.status == 'cancelled' %}bg-red-100 text-red-800{% elif item.data.status == 'inactive' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if item.data.status == 'active' %}–ê–∫—Ç–∏–≤–Ω–∞{% elif item.data.status == 'cancelled' %}–û—Ç–º–µ–Ω–µ–Ω–∞{% elif item.data.status == 'inactive' %}–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞{% else %}–ó–∞–≤–µ—Ä—à–µ–Ω–∞{% endif %}
              </span>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      </div>
    {% endif %}

    <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ -->
    {% if operator_stats %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for user_id, stats in operator_stats.items() %}
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-gray-900">{{ stats.name }}</h4>
            <span class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
              {{ stats.role|title }}
            </span>
          </div>
          
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">–ó–∞–ø–∏—Å–µ–π –∑–∞–ª–∏–≤–∫–∏:</span>
              <span class="font-bold text-blue-600">{{ stats.entries_count }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">–°–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π:</span>
              <span class="font-bold text-green-600">{{ stats.batches_count }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
              <span class="text-sm text-gray-500">{{ stats.last_activity.strftime('%d.%m %H:%M') }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      </div>
    {% endif %}


  </main>

  <script>
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const shiftData = [{{ day_entries }}, {{ night_entries }}];
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –ª–æ–≥–∏–∫—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
    const materialsData = [
      {% if materials_total and materials_total.get('–¶–µ–º–µ–Ω—Ç') %}{{ materials_total['–¶–µ–º–µ–Ω—Ç'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('–ò–∑–≤–µ—Å—Ç—å') %}{{ materials_total['–ò–∑–≤–µ—Å—Ç—å'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('–ê–ª—é–º–∏–Ω–∏–µ–≤–∞—è –ø—É–¥—Ä–∞') %}{{ materials_total['–ê–ª—é–º–∏–Ω–∏–µ–≤–∞—è –ø—É–¥—Ä–∞'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('–®–ª–∞–º') %}{{ materials_total['–®–ª–∞–º'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('–ì–∏–ø—Å') %}{{ materials_total['–ì–∏–ø—Å'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('–í–æ–¥–∞') %}{{ materials_total['–í–æ–¥–∞'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('–°—É–ª—å—Ñ–∞–Ω–æ–ª') %}{{ materials_total['–°—É–ª—å—Ñ–∞–Ω–æ–ª'].quantity|default(0) }}{% else %}0{% endif %}
    ];

    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å–º–µ–Ω–∞–º
    const shiftCtx = document.getElementById('shiftChart').getContext('2d');
    new Chart(shiftCtx, {
      type: 'doughnut',
      data: {
        labels: ['–î–Ω–µ–≤–Ω–∞—è —Å–º–µ–Ω–∞', '–ù–æ—á–Ω–∞—è —Å–º–µ–Ω–∞'],
        datasets: [{
          data: shiftData,
          backgroundColor: ['#3b82f6', '#64748b'],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              usePointStyle: true,
              font: {
                size: 11,
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
              }
            }
          }
        }
      }
    });

    // –ì—Ä–∞—Ñ–∏–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    const materialsCtx = document.getElementById('materialsChart').getContext('2d');
    new Chart(materialsCtx, {
      type: 'bar',
      data: {
        labels: ['–¶–µ–º–µ–Ω—Ç', '–ò–∑–≤–µ—Å—Ç—å', '–ê–ª—é–º–∏–Ω–∏–µ–≤–∞—è –ø—É–¥—Ä–∞', '–®–ª–∞–º', '–ì–∏–ø—Å', '–í–æ–¥–∞', '–°—É–ª—å—Ñ–∞–Ω–æ–ª'],
        datasets: [{
          label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∫–≥/–ª)',
          data: materialsData,
          backgroundColor: [
            '#64748b', '#475569', '#334155', '#1e293b', 
            '#0f172a', '#3b82f6', '#1d4ed8'
          ],
          borderWidth: 0,
          borderRadius: 4,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1.5,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 9,
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
              },
              maxRotation: 45
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: '#f1f5f9'
            },
            ticks: {
              font: {
                size: 9,
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
              }
            }
          }
        }
      }
    });

    console.log('–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
  </script>

</body>
</html>