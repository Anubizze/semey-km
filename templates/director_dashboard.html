<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Производственная панель управления</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .metric-card {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .metric-value {
      color: #1e293b;
      font-weight: 700;
    }
    .metric-label {
      color: #64748b;
      font-weight: 500;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-good { background-color: #10b981; }
    .status-warning { background-color: #f59e0b; }
    .status-danger { background-color: #ef4444; }
    .status-info { background-color: #3b82f6; }
    
    /* Мобильная адаптивность */
    @media (max-width: 768px) {
      .max-w-7xl {
        padding: 0 1rem;
      }
      .grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .grid-cols-2 {
        grid-template-columns: 1fr;
      }
      .grid-cols-3 {
        grid-template-columns: 1fr;
      }
      .grid-cols-4 {
        grid-template-columns: 1fr;
      }
      .grid-cols-5 {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-cols-7 {
        grid-template-columns: repeat(2, 1fr);
      }
      .metric-card {
        padding: 1rem;
      }
      .metric-value {
        font-size: 1.5rem;
      }
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table {
        font-size: 12px;
        min-width: 600px;
      }
      .table th, .table td {
        padding: 8px 4px;
        white-space: nowrap;
      }
      .flex {
        flex-direction: column;
        gap: 0.5rem;
      }
      .flex.justify-between {
        align-items: flex-start;
      }
      .text-right {
        text-align: left;
      }
      .space-x-4 > * + * {
        margin-left: 0;
        margin-top: 0.5rem;
      }
      .space-x-2 > * + * {
        margin-left: 0;
        margin-top: 0.25rem;
      }
      .space-y-3 > * + * {
        margin-top: 0.75rem;
      }
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
      .space-y-6 > * + * {
        margin-top: 1.5rem;
      }
      .space-y-8 > * + * {
        margin-top: 2rem;
      }
      .h-64 {
        height: 200px;
      }
      .h-80 {
        height: 250px;
      }
      .text-sm {
        font-size: 11px;
      }
      .text-xs {
        font-size: 10px;
      }
      .px-4 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .py-3 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .p-6 {
        padding: 1rem;
      }
      .p-4 {
        padding: 0.75rem;
      }
      .mb-8 {
        margin-bottom: 1.5rem;
      }
      .mb-6 {
        margin-bottom: 1rem;
      }
      .mb-4 {
        margin-bottom: 0.75rem;
      }
      .mt-4 {
        margin-top: 0.75rem;
      }
      .mt-6 {
        margin-top: 1rem;
      }
      .mt-8 {
        margin-top: 1.5rem;
      }
      .text-lg {
        font-size: 1rem;
      }
      .text-xl {
        font-size: 1.125rem;
      }
      .text-2xl {
        font-size: 1.25rem;
      }
      .text-3xl {
        font-size: 1.5rem;
      }
      .text-4xl {
        font-size: 1.75rem;
      }
      .text-5xl {
        font-size: 2rem;
      }
      .text-6xl {
        font-size: 2.25rem;
      }
      .text-7xl {
        font-size: 2.5rem;
      }
      .text-8xl {
        font-size: 2.75rem;
      }
      .text-9xl {
        font-size: 3rem;
      }
    }
    
    @media (max-width: 480px) {
      .max-w-7xl {
        padding: 0 0.5rem;
      }
      .grid-cols-5 {
        grid-template-columns: 1fr;
      }
      .grid-cols-7 {
        grid-template-columns: 1fr;
      }
      .metric-card {
        padding: 0.75rem;
      }
      .metric-value {
        font-size: 1.25rem;
      }
      .table {
        font-size: 10px;
        min-width: 500px;
      }
      .table th, .table td {
        padding: 6px 2px;
      }
      .text-sm {
        font-size: 10px;
      }
      .text-xs {
        font-size: 9px;
      }
      .h-64 {
        height: 150px;
      }
      .h-80 {
        height: 200px;
      }
      .px-4 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      .py-3 {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }
      .p-6 {
        padding: 0.75rem;
      }
      .p-4 {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- Заголовок -->
  <header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <img src="{{ url_for('static', filename='images/logo_0.png') }}" alt="Логотип" class="h-12 w-auto mr-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">
              {% if session.get('role') == 'chief_technologist' %}
                Панель управления производством - Главный технолог
              {% else %}
                Панель управления производством - Директор
              {% endif %}
            </h1>
            <p class="text-sm text-gray-600">Система мониторинга производственных процессов</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-500">{{ date_from }} - {{ date_to }}</span>
          <a href="/logout" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            Выход
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Панель фильтров -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <form method="GET" action="/director_dashboard" class="grid grid-cols-1 md:grid-cols-7 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Дата с</label>
          <input type="date" name="date_from" value="{{ date_from }}" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Дата по</label>
          <input type="date" name="date_to" value="{{ date_to }}" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Тип партии</label>
          <select name="batch_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if batch_type_filter == 'all' %}selected{% endif %}>Все типы</option>
            <option value="cutting" {% if batch_type_filter == 'cutting' %}selected{% endif %}>Резка</option>
            <option value="autoclave" {% if batch_type_filter == 'autoclave' %}selected{% endif %}>Автоклав</option>
            <option value="casting" {% if batch_type_filter == 'casting' %}selected{% endif %}>Заливка</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Статус</label>
          <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Все статусы</option>
            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Активные</option>
            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Завершенные</option>
            <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Отмененные</option>
            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Приостановленные</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Продукт</label>
          <select name="product" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if product_filter == 'all' %}selected{% endif %}>Все продукты</option>
            {% for product in products %}
            <option value="{{ product.id }}" {% if product_filter == product.id|string %}selected{% endif %}>{{ product.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Оборудование</label>
          <select name="equipment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all" {% if equipment_filter == 'all' %}selected{% endif %}>Все оборудование</option>
            {% for eq in equipment %}
            <option value="{{ eq.id }}" {% if equipment_filter == eq.id|string %}selected{% endif %}>{{ eq.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-end space-x-2">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            Применить
          </button>
          <a href="/director_dashboard" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition-colors">
            Сбросить
          </a>
        </div>
      </form>
      
      <!-- Кнопки экспорта -->
      <div class="mt-4 flex flex-wrap gap-2">
        <a href="{{ url_for('export_batches_csv', date_from=date_from, date_to=date_to, batch_type=batch_type_filter, status=status_filter, product=product_filter, equipment=equipment_filter) }}" 
           class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          📊 Экспорт партий (Excel)
        </a>
        <a href="{{ url_for('export_entries_csv', date_from=date_from, date_to=date_to) }}" 
           class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          📋 Экспорт записей (Excel)
        </a>
        <a href="{{ url_for('export_analytics_csv', date_from=date_from, date_to=date_to) }}" 
           class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          📈 Экспорт аналитики (Excel)
        </a>
        <a href="{{ url_for('clear_cache') }}" 
           class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"
           onclick="return confirm('Очистить кэш? Это может замедлить загрузку страницы.')">
          🗑️ Очистить кэш
        </a>
        <a href="{{ url_for('cache_status') }}" 
           class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          📊 Статус кэша
        </a>
        {% if session.get('role') == 'chief_technologist' %}
        <a href="/templates" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
          📋 Шаблоны партий
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Основной контент -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- 7 ключевых производственных метрик -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      
      <!-- 1. Общая выработка -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">Общая выработка</p>
            <p class="metric-value text-3xl">{{ total_production }}</p>
            <p class="text-xs text-gray-500 mt-1">партий</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator status-info"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">Всего операций</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Простой -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">Простой</p>
            <p class="metric-value text-3xl">{{ downtime_batches }}</p>
            <p class="text-xs text-gray-500 mt-1">неактивных партий</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if downtime_batches > 5 %}status-danger{% elif downtime_batches > 2 %}status-warning{% else %}status-good{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">Производственные потери</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Время работы -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">Время работы</p>
            <p class="metric-value text-3xl">{{ active_time_batches }}</p>
            <p class="text-xs text-gray-500 mt-1">активных партий</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator status-good"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">Текущая загрузка</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Количество брака -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">Количество брака</p>
            <p class="metric-value text-3xl">{{ defect_batches }}</p>
            <p class="text-xs text-gray-500 mt-1">дефектных партий</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if defect_batches > 3 %}status-danger{% elif defect_batches > 1 %}status-warning{% else %}status-good{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">Контроль качества</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 5. Нарушения технологий -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">Нарушения технологий</p>
            <p class="metric-value text-3xl">{{ tech_violations }}</p>
            <p class="text-xs text-gray-500 mt-1">нарушений</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if tech_violations > 2 %}status-danger{% elif tech_violations > 0 %}status-warning{% else %}status-good{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">Соблюдение стандартов</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 6. Эффективность -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">Эффективность</p>
            <p class="metric-value text-3xl">{{ "%.1f"|format(efficiency) }}%</p>
            <p class="text-xs text-gray-500 mt-1">завершенных партий</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator {% if efficiency >= 80 %}status-good{% elif efficiency >= 60 %}status-warning{% else %}status-danger{% endif %}"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">Производственная эффективность</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 7. Средняя длительность -->
      <div class="metric-card rounded-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="metric-label text-sm">Средняя длительность</p>
            <p class="metric-value text-3xl">{{ "%.0f"|format(avg_duration) }}</p>
            <p class="text-xs text-gray-500 mt-1">минут</p>
          </div>
          <div class="flex items-center">
            <span class="status-indicator status-info"></span>
            <div class="text-right">
              <p class="text-xs text-gray-500">Время выполнения операций</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Аналитика производственных операций -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Аналитика производственных операций</h3>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Партии резки -->
        <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-blue-800">Резка</h4>
            <span class="text-2xl">✂️</span>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Всего партий:</span>
              <span class="text-2xl font-bold text-blue-700">{{ total_cutting_batches }}</span>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">Активных</div>
                <div class="text-lg font-bold text-green-600">{{ active_cutting }}</div>
              </div>
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">Завершенных</div>
                <div class="text-lg font-bold text-gray-600">{{ completed_cutting }}</div>
              </div>
            </div>
            <div class="bg-white/60 rounded-md p-3">
              <div class="text-xs text-gray-600 mb-1">Средняя длительность</div>
              <div class="text-lg font-bold text-blue-700">{{ "%.0f"|format(avg_cutting_duration) }} мин</div>
            </div>
          </div>
        </div>

        <!-- Циклы автоклавирования -->
        <div class="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-purple-800">Автоклав</h4>
            <span class="text-2xl">🔥</span>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Всего циклов:</span>
              <span class="text-2xl font-bold text-purple-700">{{ total_autoclave_batches }}</span>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">Активных</div>
                <div class="text-lg font-bold text-green-600">{{ active_autoclave }}</div>
              </div>
              <div class="bg-white/60 rounded-md p-3 text-center">
                <div class="text-xs text-gray-600">Завершенных</div>
                <div class="text-lg font-bold text-gray-600">{{ completed_autoclave }}</div>
              </div>
            </div>
            <div class="bg-white/60 rounded-md p-3">
              <div class="text-xs text-gray-600 mb-1">Средняя длительность</div>
              <div class="text-lg font-bold text-purple-700">{{ "%.0f"|format(avg_autoclave_duration) }} мин</div>
            </div>
          </div>
        </div>

        <!-- Партии заливки -->
        <div class="p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg border border-orange-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-orange-800">Заливка</h4>
            <span class="text-2xl">🧱</span>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Всего партий:</span>
              <span class="text-2xl font-bold text-orange-700">{{ total_casting_batches }}</span>
            </div>
            <div class="bg-white/60 rounded-md p-4">
              <p class="text-sm text-gray-600">
                📋 Подробная информация доступна в разделе "Все партии"
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Визуализация данных -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Визуализация производственных данных</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- График по сменам -->
        <div class="relative">
          <h4 class="text-md font-medium text-gray-700 mb-4">Распределение по сменам</h4>
          <div class="relative h-64">
            <canvas id="shiftChart"></canvas>
          </div>
          
          <!-- Детализация по типам операций -->
          <div class="mt-4 space-y-3">
            <div class="text-sm text-gray-600 font-medium mb-2">Детализация по операциям:</div>
            
            <!-- Заливка -->
            <div class="flex items-center justify-between p-2 bg-blue-50 rounded-md">
              <div class="flex items-center">
                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                <span class="text-sm font-medium text-gray-700">Заливка</span>
              </div>
              <div class="flex space-x-4 text-xs">
                <span class="text-blue-600">🌅 {{ day_entries_casting }}</span>
                <span class="text-gray-600">🌙 {{ night_entries_casting }}</span>
              </div>
            </div>
            
            <!-- Резка -->
            <div class="flex items-center justify-between p-2 bg-green-50 rounded-md">
              <div class="flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                <span class="text-sm font-medium text-gray-700">Резка</span>
              </div>
              <div class="flex space-x-4 text-xs">
                <span class="text-green-600">🌅 {{ day_entries_cutting }}</span>
                <span class="text-gray-600">🌙 {{ night_entries_cutting }}</span>
              </div>
            </div>
            
            <!-- Автоклав -->
            <div class="flex items-center justify-between p-2 bg-purple-50 rounded-md">
              <div class="flex items-center">
                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                <span class="text-sm font-medium text-gray-700">Автоклав</span>
              </div>
              <div class="flex space-x-4 text-xs">
                <span class="text-purple-600">🌅 {{ day_entries_autoclave }}</span>
                <span class="text-gray-600">🌙 {{ night_entries_autoclave }}</span>
              </div>
            </div>
          </div>
        </div>
        <!-- График потребления материалов -->
        <div class="relative">
          <h4 class="text-md font-medium text-gray-700 mb-4">Потребление материалов</h4>
          <div class="relative h-64">
            <canvas id="materialsChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Детальная аналитика -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      
      <!-- Аналитика по типам партий -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Аналитика по типам партий</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between p-3 bg-blue-50 rounded-md">
            <div class="flex items-center">
              <span class="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>
              <span class="text-sm font-medium text-gray-700">Резка</span>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">{{ total_cutting_batches }}</p>
              <p class="text-xs text-gray-500">партий</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-purple-50 rounded-md">
            <div class="flex items-center">
              <span class="w-3 h-3 bg-purple-500 rounded-full mr-3"></span>
              <span class="text-sm font-medium text-gray-700">Автоклав</span>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">{{ total_autoclave_batches }}</p>
              <p class="text-xs text-gray-500">циклов</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-orange-50 rounded-md">
            <div class="flex items-center">
              <span class="w-3 h-3 bg-orange-500 rounded-full mr-3"></span>
              <span class="text-sm font-medium text-gray-700">Заливка</span>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">{{ total_casting_batches }}</p>
              <p class="text-xs text-gray-500">партий</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Расход материалов -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Расход материалов</h3>
        <div class="space-y-3">
          {% for material_name, data in materials_total.items() %}
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">{{ material_name }}</span>
            <div class="text-right">
              <span class="text-sm font-semibold text-gray-900">{{ "%.1f"|format(data.quantity) }}</span>
              <span class="text-xs text-gray-500 ml-1">{{ data.unit }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

    </div>

    <!-- Общий расход сырья за период -->
    {% if materials_total %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Общий расход сырья за период</h3>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for material_name, data in materials_total.items() %}
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center">
          <p class="text-sm font-medium text-gray-600 mb-2">{{ material_name }}</p>
          <p class="text-2xl font-bold text-gray-900 mb-1">{{ "%.1f"|format(data.quantity) }}</p>
          <p class="text-xs text-gray-500 uppercase">{{ data.unit }}</p>
        </div>
        {% endfor %}
      </div>
      <div class="mt-4 pt-4 border-t border-gray-200">
        <div class="flex items-center justify-between text-sm text-gray-600">
          <span>📅 Период: {{ date_from }} - {{ date_to }}</span>
          {% if batch_type_filter != 'all' %}
          <span>🔍 Тип партии: 
            {% if batch_type_filter == 'casting' %}Заливка
            {% elif batch_type_filter == 'cutting' %}Резка
            {% elif batch_type_filter == 'autoclave' %}Автоклав
            {% endif %}
          </span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Аналитика по продуктам -->
    {% if products_stats %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Аналитика по продуктам</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for product_code, stats in products_stats.items() %}
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-gray-900">{{ product_code }}</h4>
            <span class="text-sm text-gray-500">{{ stats.name }}</span>
          </div>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="bg-blue-50 rounded-md p-2">
              <div class="text-xs text-gray-600">Всего</div>
              <div class="text-lg font-bold text-blue-600">{{ stats.total }}</div>
            </div>
            <div class="bg-green-50 rounded-md p-2">
              <div class="text-xs text-gray-600">Активных</div>
              <div class="text-lg font-bold text-green-600">{{ stats.active }}</div>
            </div>
            <div class="bg-gray-50 rounded-md p-2">
              <div class="text-xs text-gray-600">Завершенных</div>
              <div class="text-lg font-bold text-gray-600">{{ stats.completed }}</div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Расход сырья по типам партий -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Расход сырья по типам партий</h3>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Заливка -->
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="font-semibold text-blue-800 mb-3">Заливка</h4>
          {% if materials_by_batch_type.casting %}
          <div class="space-y-2">
            {% for material_name, data in materials_by_batch_type.casting.items() %}
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-700">{{ material_name }}</span>
              <span class="font-semibold text-blue-700">{{ "%.1f"|format(data.quantity) }} {{ data.unit }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm">Нет данных</p>
          {% endif %}
        </div>

        <!-- Резка -->
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
          <h4 class="font-semibold text-green-800 mb-3">Резка</h4>
          {% if materials_by_batch_type.cutting %}
          <div class="space-y-2">
            {% for material_name, data in materials_by_batch_type.cutting.items() %}
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-700">{{ material_name }}</span>
              <span class="font-semibold text-green-700">{{ "%.1f"|format(data.quantity) }} {{ data.unit }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm">Нет данных</p>
          {% endif %}
        </div>

        <!-- Автоклав -->
        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
          <h4 class="font-semibold text-purple-800 mb-3">Автоклав</h4>
          {% if materials_by_batch_type.autoclave %}
          <div class="space-y-2">
            {% for material_name, data in materials_by_batch_type.autoclave.items() %}
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-700">{{ material_name }}</span>
              <span class="font-semibold text-purple-700">{{ "%.1f"|format(data.quantity) }} {{ data.unit }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm">Нет данных</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Последние производственные операции -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Последние производственные операции</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Последние партии резки -->
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="text-md font-semibold text-blue-800 mb-4 flex items-center">
            <span class="mr-2">✂️</span> Последние партии резки
          </h4>
          {% if cutting_batches %}
          <div class="space-y-3 max-h-64 overflow-y-auto">
            {% for batch, user in cutting_batches[:5] %}
            <div class="p-3 bg-white rounded-md border-l-4 {% if batch.status == 'active' %}border-green-500{% elif batch.status == 'cancelled' %}border-red-500{% elif batch.status == 'inactive' %}border-yellow-500{% else %}border-gray-400{% endif %}">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold text-gray-900">{{ batch.batch_number }}</p>
                  <p class="text-sm text-gray-600">Резчик: {{ user.fio }}</p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full {% if batch.status == 'active' %}bg-green-100 text-green-800{% elif batch.status == 'cancelled' %}bg-red-100 text-red-800{% elif batch.status == 'inactive' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                  {% if batch.status == 'active' %}Активна{% elif batch.status == 'cancelled' %}Отменена{% elif batch.status == 'inactive' %}Приостановлена{% else %}Завершена{% endif %}
                </span>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                Начало: {{ batch.start_time.strftime('%d.%m.%Y %H:%M') }}
                {% if batch.end_time %}
                | Окончание: {{ batch.end_time.strftime('%H:%M') }}
                {% endif %}
              </p>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-center py-4">Нет партий резки</p>
          {% endif %}
          <div class="mt-4">
            <a href="/batch_list" class="text-blue-600 hover:underline text-sm">Все партии →</a>
          </div>
        </div>

        <!-- Последние циклы автоклавирования -->
        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
          <h4 class="text-md font-semibold text-purple-800 mb-4 flex items-center">
            <span class="mr-2">🔥</span> Последние циклы автоклавирования
          </h4>
          {% if autoclave_batches %}
          <div class="space-y-3 max-h-64 overflow-y-auto">
            {% for batch, user in autoclave_batches[:5] %}
            <div class="p-3 bg-white rounded-md border-l-4 {% if batch.status == 'active' %}border-purple-500{% elif batch.status == 'cancelled' %}border-red-500{% elif batch.status == 'inactive' %}border-yellow-500{% else %}border-gray-400{% endif %}">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold text-gray-900">{{ batch.batch_number }}</p>
                  <p class="text-sm text-gray-600">Автоклавщик: {{ user.fio }}</p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full {% if batch.status == 'active' %}bg-purple-100 text-purple-800{% elif batch.status == 'cancelled' %}bg-red-100 text-red-800{% elif batch.status == 'inactive' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                  {% if batch.status == 'active' %}Активен{% elif batch.status == 'cancelled' %}Отменен{% elif batch.status == 'inactive' %}Приостановлен{% else %}Завершен{% endif %}
                </span>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                Начало: {{ batch.start_time.strftime('%d.%m.%Y %H:%M') }}
                {% if batch.end_time %}
                | Окончание: {{ batch.end_time.strftime('%H:%M') }}
                {% endif %}
              </p>
              {% if batch.equipment %}
              <p class="text-xs text-gray-500 mt-1">Оборудование: {{ batch.equipment.name }}</p>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-center py-4">Нет циклов автоклавирования</p>
          {% endif %}
          <div class="mt-4">
            <a href="/batch_list" class="text-purple-600 hover:underline text-sm">Все партии →</a>
          </div>
        </div>

      </div>
    </div>

    <!-- Последние записи ввода материалов -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Последние записи ввода материалов</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto">
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200">
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Время</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Сотрудник</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Смена</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цемент (кг)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Известь (кг)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ал. пудра (кг)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Вода (л)</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for entry in material_entries[:10] %}
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ entry.datetime.date() }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ entry.datetime.time().strftime('%H:%M:%S') }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                {{ entry.user.fio }}
                {% if entry.type == 'batch' %}
                  <span class="text-xs text-gray-500">({{ entry.batch_type }})</span>
                {% endif %}
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span class="px-2 py-1 text-xs rounded-full {{ 'bg-yellow-100 text-yellow-800' if entry.shift == 'day' else 'bg-blue-100 text-blue-800' }}">
                  {{ 'Дневная' if entry.shift == 'day' else 'Ночная' }}
                </span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.cement) }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.lime) }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.aluminum_powder) }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(entry.water) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if not material_entries %}
      <div class="text-center py-8">
        <p class="text-gray-500">Нет записей ввода материалов</p>
      </div>
      {% endif %}
    </div>

    <!-- Лента операций -->
    {% if entries_timeline %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Лента операций за период</h3>
      <div class="space-y-3 max-h-96 overflow-y-auto">
        {% for item in entries_timeline[:15] %}
        <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-md">
          <div class="flex-shrink-0">
            {% if item.type == 'entry' %}
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <span class="text-blue-600 text-sm">📝</span>
              </div>
            {% elif item.type == 'batch' %}
              <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <span class="text-green-600 text-sm">
                  {% if item.data.batch_type == 'cutting' %}✂️
                  {% elif item.data.batch_type == 'autoclave' %}🔥
                  {% elif item.data.batch_type == 'casting' %}🧱
                  {% else %}📦{% endif %}
                </span>
              </div>
            {% endif %}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900">{{ item.description }}</p>
            <div class="flex items-center space-x-2">
              <p class="text-xs text-gray-500">{{ item.user.fio }} • {{ item.datetime.strftime('%d.%m.%Y %H:%M') }}</p>
              {% if item.type == 'batch' %}
              <span class="px-2 py-1 text-xs rounded-full {% if item.data.status == 'active' %}bg-green-100 text-green-800{% elif item.data.status == 'cancelled' %}bg-red-100 text-red-800{% elif item.data.status == 'inactive' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if item.data.status == 'active' %}Активна{% elif item.data.status == 'cancelled' %}Отменена{% elif item.data.status == 'inactive' %}Приостановлена{% else %}Завершена{% endif %}
              </span>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      </div>
    {% endif %}

    <!-- Активность операторов -->
    {% if operator_stats %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Активность операторов</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for user_id, stats in operator_stats.items() %}
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-gray-900">{{ stats.name }}</h4>
            <span class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
              {{ stats.role|title }}
            </span>
          </div>
          
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Записей заливки:</span>
              <span class="font-bold text-blue-600">{{ stats.entries_count }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Созданных партий:</span>
              <span class="font-bold text-green-600">{{ stats.batches_count }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Последняя активность:</span>
              <span class="text-sm text-gray-500">{{ stats.last_activity.strftime('%d.%m %H:%M') }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      </div>
    {% endif %}


  </main>

  <script>
    // Данные для графиков
    const shiftData = [{{ day_entries }}, {{ night_entries }}];
    
    // Используем общую логику материалов (статические данные из всех источников)
    const materialsData = [
      {% if materials_total and materials_total.get('Цемент') %}{{ materials_total['Цемент'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('Известь') %}{{ materials_total['Известь'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('Алюминиевая пудра') %}{{ materials_total['Алюминиевая пудра'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('Шлам') %}{{ materials_total['Шлам'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('Гипс') %}{{ materials_total['Гипс'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('Вода') %}{{ materials_total['Вода'].quantity|default(0) }}{% else %}0{% endif %},
      {% if materials_total and materials_total.get('Сульфанол') %}{{ materials_total['Сульфанол'].quantity|default(0) }}{% else %}0{% endif %}
    ];

    // График по сменам
    const shiftCtx = document.getElementById('shiftChart').getContext('2d');
    new Chart(shiftCtx, {
      type: 'doughnut',
      data: {
        labels: ['Дневная смена', 'Ночная смена'],
        datasets: [{
          data: shiftData,
          backgroundColor: ['#3b82f6', '#64748b'],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              usePointStyle: true,
              font: {
                size: 11,
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
              }
            }
          }
        }
      }
    });

    // График материалов
    const materialsCtx = document.getElementById('materialsChart').getContext('2d');
    new Chart(materialsCtx, {
      type: 'bar',
      data: {
        labels: ['Цемент', 'Известь', 'Алюминиевая пудра', 'Шлам', 'Гипс', 'Вода', 'Сульфанол'],
        datasets: [{
          label: 'Количество (кг/л)',
          data: materialsData,
          backgroundColor: [
            '#64748b', '#475569', '#334155', '#1e293b', 
            '#0f172a', '#3b82f6', '#1d4ed8'
          ],
          borderWidth: 0,
          borderRadius: 4,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1.5,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 9,
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
              },
              maxRotation: 45
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: '#f1f5f9'
            },
            ticks: {
              font: {
                size: 9,
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
              }
            }
          }
        }
      }
    });

    console.log('Производственная панель управления загружена');
  </script>

</body>
</html>